<%= form_with(model: producto, class: "row g-3") do |form| %>
  <% if producto.errors.any? %>
    <div class="alert alert-danger">
      <h2><%= pluralize(producto.errors.count, "error") %> impidieron guardar el producto:</h2>
      <ul>
        <% producto.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="col-12">
    <%= form.label :titulo, "Título", class: "form-label" %>
    <%= form.text_field :titulo, class: "form-control", required: true, minlength: 2, maxlength: 100 %>
  </div>

  <div class="col-12">
    <%= form.label :descripcion, "Descripción", class: "form-label" %>
    <%= form.text_area :descripcion, class: "form-control", rows: 3, maxlength: 500 %>
  </div>

  <div class="col-12">
    <%= form.label :autor, "Autor", class: "form-label" %>
    <%= form.text_field :autor, class: "form-control", required: true, minlength: 2, maxlength: 100 %>
  </div>

  <div class="col-6">
    <%= form.label :precio, "Precio", class: "form-label" %>
    <%= form.number_field :precio, step: 0.01, min: 0.01, class: "form-control", required: true %>
    <small class="text-muted">Debe ser mayor a 0</small>
  </div>

  <div class="col-6">
    <%= form.label :stock, "Stock", class: "form-label" %>
    <%= form.number_field :stock, class: "form-control", min: 0, id: "stock_field", value: producto.stock || 1, required: true %>
    <small class="text-muted">Debe ser un número entero >= 0</small>
  </div>

  <div class="col-6">
    <%= form.label :categoria, "Género musical", class: "form-label" %>
    <%= form.select :categoria,
          [
            ["Rock", "rock"],
            ["Pop", "pop"],
            ["Jazz", "jazz"],
            ["Blues", "blues"],
            ["Clásica", "clasica"],
            ["Reggae", "reggae"],
            ["Hip-Hop", "hiphop"],
            ["Metal", "metal"],
            ["Electrónica", "electronica"]
          ],
          { include_blank: "Seleccione género" }, class: "form-control", required: true %>
  </div>

  <div class="col-6">
    <%= form.label :tipo, "Tipo", class: "form-label" %>
    <%= form.select :tipo,
          [["Vinilo", "vinilo"], ["CD", "cd"]],
          { include_blank: "Seleccione tipo" }, class: "form-control", required: true %>
  </div>

  <div class="col-6">
    <%= form.label :estado_fisico, "Estado del producto", class: "form-label" %>
    <%= form.select :estado_fisico,
          [["Nuevo", "nuevo"], ["Usado", "usado"]],
          { include_blank: "Seleccione estado" }, class: "form-control", id: "estado_fisico_select", required: true %>
  </div>

  <% if producto.persisted? && producto.estado == "eliminado" %>
    <div class="col-6">
      <%= form.label :estado, "Estado", class: "form-label" %>
      <%= form.select :estado,
            [["Activo", "activo"], ["Eliminado", "eliminado"]],
            {}, class: "form-control" %>
      <small class="text-muted">Este producto está eliminado. Puedes reactivarlo.</small>
    </div>
  <% elsif producto.new_record? %>
    <%= form.hidden_field :estado, value: "activo" %>
  <% end %>

  <div class="col-6">
    <%= form.label :anio, "Año", class: "form-label" %>
    <%= form.number_field :anio, class: "form-control", min: 1900, max: Time.current.year, required: true %>
    <small class="text-muted">Entre 1900 y <%= Time.current.year %></small>
  </div>

  <div class="col-12">
    <%= form.label :imagenes, "Imágenes", class: "form-label" %>
    <%= form.file_field :imagenes, multiple: true, accept: "image/png,image/jpeg,image/jpg", class: "form-control", required: producto.new_record? %>
    <small class="text-muted">Al menos una imagen es obligatoria. Formatos: PNG, JPG, JPEG</small>
  </div>

  <div class="col-12" id="audio-muestra-field" style="<%= producto.estado_fisico == "usado" ? "" : "display:none;" %>">
    <%= form.label :audio_muestra, "Audio de muestra", class: "form-label" %>
    <%= form.file_field :audio_muestra, accept: "audio/mp3,audio/mpeg", class: "form-control" %>
    <small class="text-muted">Solo para productos usados. Formato: MP3</small>
  </div>

  <div class="col-12 mt-3">
    <%= form.submit "Guardar", class: "btn btn-as-dark" %>
  </div>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var estadoSelect = document.getElementById("estado_fisico_select");
    var audioField = document.getElementById("audio-muestra-field");
    var stockField = document.getElementById("stock_field");
    function toggleFields() {
      if (estadoSelect.value === "usado") {
        audioField.style.display = "";
        stockField.value = 1;
        stockField.readOnly = true;
      } else {
        audioField.style.display = "none";
        stockField.readOnly = false;
      }
    }
    if (estadoSelect) {
      estadoSelect.addEventListener("change", toggleFields);
      toggleFields();
    }
  });
</script>
<div class="main-card venta-card-wrapper" style="position:relative;">
  
  <% if @venta.cancelada? %>
    <div class="cancelled-note mb-2">
      <strong>Venta cancelada</strong>
      <% if @venta.respond_to?(:fecha_cancelacion) && @venta.fecha_cancelacion.present? %>
        — Fecha: <%= l(@venta.fecha_cancelacion, format: :long) rescue @venta.fecha_cancelacion %>
      <% end %>
    </div>
  <% end %>

  <h2 class="mb-3">Venta #<%= @venta.id %></h2>

  <div class="row g-3">
    <div class="col-md-6">
      <strong>Fecha y hora:</strong>
      <div><%= l(@venta.fecha_hora, format: :long) rescue @venta.fecha_hora %></div>
    </div>

    <div class="col-md-6">
      <strong>Cliente:</strong>
      <div><%= @venta.cliente.try(:nombre) || @venta.cliente_id %></div>
    </div>

    <div class="col-md-6">
      <strong>Teléfono del cliente:</strong>
      <div><%= @venta.cliente.try(:telefono) || "N/A" %></div>
    </div>

    <div class="col-md-6">
      <strong>DNI del cliente:</strong>
      <div><%= @venta.cliente.try(:dni) || "N/A" %></div>
    </div>

    <div class="col-md-6">
      <strong>Empleado:</strong>
      <div><%= @venta.empleado.try(:nombre) || @venta.empleado_id %></div>
    </div>

    <div class="col-md-6">
      <strong>Medio de pago:</strong>
      <div><%= @venta.pago.present? ? @venta.pago.humanize : "N/A" %></div>
    </div>

    <div class="col-12">
      <strong>Productos vendidos:</strong>

      <%# Reemplazamos la iteración por detalle_ventas para mostrar cantidad/precio/subtotal de forma robusta %>
      <table class="table table-sm table-bordered mt-2">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Precio unitario</th>
            <th class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <% total_calculado = 0.0 %>
          <% @venta.detalle_ventas.includes(:producto).each do |dv| %>
            <% prod = dv.producto %>
            <% # precio_confiable: primero dv.precio (valor guardado en el detalle), si no está presente usar producto.precio %>
            <% precio_unit = (dv.precio.present? && dv.precio.to_f > 0) ? dv.precio.to_f : (prod&.precio.to_f || 0.0) %>
            <% subtotal = dv.cantidad.to_i * precio_unit %>
            <% total_calculado += subtotal %>
            <tr>
              <td>
                <% if prod %>
                  <%= link_to prod.titulo, producto_path(prod) rescue prod.titulo %>
                <% else %>
                  <em>Producto eliminado</em>
                <% end %>
              </td>
              <td class="text-center"><%= dv.cantidad %></td>
              <td class="text-end">$<%= number_with_precision(precio_unit, precision: 2) %></td>
              <td class="text-end">$<%= number_with_precision(subtotal, precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Total calculado:</th>
            <th class="text-end">$<%= number_with_precision(total_calculado, precision: 2) %></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  

  <hr>

  <div class="d-flex gap-2 mt-3">
    <%= link_to({ controller: 'venta', action: :edit, id: @venta }, class: "btn btn-as-dark") do %>
      <i class="bi bi-pencil"></i> Editar
    <% end %>

    <%= button_to({ controller: 'venta', action: :destroy, id: @venta }, method: :delete, data: { confirm: "¿Eliminar venta?" }, class: "btn btn-as-dark") do %>
      <i class="bi bi-trash"></i> Cancelar venta
    <% end %>

    <%= link_to({ controller: 'venta', action: :index }, class: "btn btn-as-dark") do %>
      <i class="bi bi-arrow-left"></i> Volver
    <% end %>
    
    <%= link_to venta_path(@venta, format: :pdf), class: "btn btn-as-dark" do %>
      <i class="bi bi-file-earmark-pdf"></i> Descargar factura
    <% end %>
  </div>
</div>

<style>
  /* nota pequeña encima del contenido */
  .cancelled-note {
    position: relative;
    z-index: 45;
    background: rgba(255,230,230,0.9);
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid rgba(200,0,0,0.12);
    color: #6b0000;
    display: inline-block;
  }
</style>
